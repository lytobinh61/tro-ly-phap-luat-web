<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tr·ª£ l√Ω ph√¢n t√≠ch vƒÉn b·∫£n ph√°p lu·∫≠t</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="main-container">

    <!-- Header -->
    <div class="header">
        <div class="title">üìò Tr·ª£ l√Ω ph√¢n t√≠ch vƒÉn b·∫£n ph√°p lu·∫≠t</div>
        <div class="user-info">
			Xin ch√†o, <strong>{{ username }}</strong>
			{% if current_user.is_admin() %}
				| <a href="{{ url_for('admin_dashboard') }}">Trang admin</a>
			{% endif %}
			| <a href="{{ url_for('logout') }}">ƒêƒÉng xu·∫•t</a>
		</div>



    </div>

    <!-- H√†ng s·ªë hi·ªáu / ch·ªß ƒë·ªÅ -->
    <div class="top-row">
        <div class="row-item">
            <label for="so-hieu">S·ªë hi·ªáu vƒÉn b·∫£n:</label>
            <input id="so-hieu" type="text" placeholder="vd: 15/2023/Nƒê-CP">
            <button type="button" onclick="timHieuVanBan()">T√¨m hi·ªÉu vƒÉn b·∫£n</button>
        </div>
        <div class="row-item">
            <label for="chu-de">Ch·ªß ƒë·ªÅ:</label>
            <input id="chu-de" type="text" placeholder="vd: chuy·ªÉn ƒë·∫•t n√¥ng nghi·ªáp sang th·ªï c∆∞">
            <button type="button" onclick="timTheoChuDe()">T√¨m ki·∫øm theo ch·ªß ƒë·ªÅ</button>
        </div>
    </div>

    <!-- Khung k·∫øt qu·∫£ -->
    <div id="result-box"></div>

    <!-- H√†ng nh·∫≠p y√™u c·∫ßu ti·∫øp -->
    <div class="bottom-row">
        <label for="chat-input">Y√™u c·∫ßu ti·∫øp:</label>
        <div class="bottom-input-row">
            <input id="chat-input" type="text"
                   placeholder="G√µ 1, 2, 3, 4, 't√≥m t·∫Øt', 'gi·∫£i th√≠ch ƒëi·ªÅu 5'... r·ªìi nh·∫•n G·ª≠i ho·∫∑c Enter">
            <button type="button" onclick="guiChat()">G·ª≠i</button>
        </div>
    </div>

</div>

<script>
    // Tr·∫°ng th√°i hi·ªán t·∫°i
    let currentMode = null;      // "tim_hieu" ho·∫∑c "chu_de"
    let currentSoHieu = "";
    let currentChuDe = "";

    function appendMessage(content, sender) {
        const box = document.getElementById("result-box");
        const div = document.createElement("div");
        div.className = sender === "user" ? "msg user" : "msg bot";
        div.innerText = (sender === "user" ? "B·∫°n: " : "Tr·ª£ l√Ω: ") + content;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function showLoading() {
        const box = document.getElementById("result-box");
        const div = document.createElement("div");
        div.id = "loading-msg";
        div.className = "msg bot";
        div.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function hideLoading() {
        const loading = document.getElementById("loading-msg");
        if (loading) loading.remove();
    }

    async function callApi(textToSend, userDisplayText = null) {
        // Hi·ªÉn th·ªã c√¢u ng∆∞·ªùi d√πng g√µ
        if (userDisplayText) {
            appendMessage(userDisplayText, "user");
        }

        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang x·ª≠ l√Ω
        showLoading();

        try {
            const res = await fetch("{{ url_for('api_send') }}", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({text: textToSend})
            });
            const data = await res.json();

            hideLoading();
            appendMessage(data.reply, "bot");
        } catch (err) {
            hideLoading();
            appendMessage("‚ùå L·ªói k·∫øt n·ªëi t·ªõi server: " + err, "bot");
        }
    }

    function timHieuVanBan() {
        const soHieu = document.getElementById("so-hieu").value.trim();
        if (!soHieu) {
            alert("B·∫°n ch∆∞a nh·∫≠p s·ªë hi·ªáu vƒÉn b·∫£n.");
            return;
        }
        currentMode = "tim_hieu";
        currentSoHieu = soHieu;

        const userText = `T√¥i ch·ªçn ch·ª©c nƒÉng 'T√¨m hi·ªÉu vƒÉn b·∫£n'. S·ªë hi·ªáu vƒÉn b·∫£n: ${soHieu}.`;
        callApi(userText, userText);
    }

    function timTheoChuDe() {
        const chuDe = document.getElementById("chu-de").value.trim();
        if (!chuDe) {
            alert("B·∫°n ch∆∞a nh·∫≠p ch·ªß ƒë·ªÅ.");
            return;
        }
        currentMode = "chu_de";
        currentChuDe = chuDe;

        const userText = `T√¥i ch·ªçn ch·ª©c nƒÉng 'T√¨m ki·∫øm theo ch·ªß ƒë·ªÅ'. Ch·ªß ƒë·ªÅ: ${chuDe}.`;
        callApi(userText, userText);
    }

    function guiChat() {
        const input = document.getElementById("chat-input");
        const text = input.value.trim();
        if (!text) return;

        // X√≥a sau khi ƒë√£ l·∫•y text (tr√°nh c·∫£m gi√°c "kh√¥ng nh·∫≠p ƒë∆∞·ª£c")
        input.value = "";

        if (!currentMode) {
            callApi(
                `Ng∆∞·ªùi d√πng ch∆∞a ch·ªçn ch·ª©c nƒÉng nh∆∞ng nh·∫≠p: "${text}". H√£y nh·∫Øc h·ªç b·∫•m 'T√¨m hi·ªÉu vƒÉn b·∫£n' ho·∫∑c 'T√¨m ki·∫øm theo ch·ªß ƒë·ªÅ' tr∆∞·ªõc.`,
                text
            );
            return;
        }

        let prompt;
        if (currentMode === "tim_hieu") {
            prompt =
                `Ch√∫ng ta ƒëang ·ªü ch·ª©c nƒÉng 'T√¨m hi·ªÉu vƒÉn b·∫£n' v·ªõi vƒÉn b·∫£n ${currentSoHieu}.\n` +
                `Ng∆∞·ªùi d√πng v·ª´a nh·∫≠p: "${text}" (c√≥ th·ªÉ l√† s·ªë l·ª±a ch·ªçn 1‚Äì4 ho·∫∑c c√¢u nh∆∞ 't√≥m t·∫Øt', 'gi·∫£i th√≠ch ƒëi·ªÅu 5').\n` +
                `H√£y:\n` +
                `- Hi·ªÉu ƒë√¢y l√† l·ª±a ch·ªçn ti·∫øp theo d·ª±a tr√™n menu 1‚Äì4 m√† b·∫°n ƒë√£ ƒë∆∞a ra tr∆∞·ªõc ƒë√≥.\n` +
                `- Th·ª±c hi·ªán H√ÄNH ƒê·ªòNG t∆∞∆°ng ·ª©ng, kh√¥ng l·∫∑p l·∫°i nguy√™n menu 1‚Äì4 n·∫øu kh√¥ng c·∫ßn thi·∫øt.\n` +
                `- Cu·ªëi c√¢u tr·∫£ l·ªùi, n·∫øu ph√π h·ª£p, nh·∫Øc l·∫°i ng·∫Øn g·ªçn: 'B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c ch·ªçn 1, 2, 3, 4 ho·∫∑c 0 ƒë·ªÉ ƒë·ªïi t√°c v·ª•'.`;
        } else if (currentMode === "chu_de") {
            prompt =
                `Ch√∫ng ta ƒëang ·ªü ch·ª©c nƒÉng 'T√¨m ki·∫øm theo ch·ªß ƒë·ªÅ' v·ªõi ch·ªß ƒë·ªÅ "${currentChuDe}".\n` +
                `Ng∆∞·ªùi d√πng v·ª´a nh·∫≠p: "${text}".\n` +
                `H√£y x·ª≠ l√Ω ƒë·∫ßu v√†o n√†y nh∆∞ b∆∞·ªõc ti·∫øp theo trong lu·ªìng 'T√¨m ki·∫øm theo ch·ªß ƒë·ªÅ', theo ƒë√∫ng Instructions: ` +
                `ho·∫∑c ph√¢n t√≠ch vƒÉn b·∫£n, ho·∫∑c t√≥m t·∫Øt ƒëi·ªÉm m·ªõi, ho·∫∑c gi·∫£i th√≠ch ƒëi·ªÅu kho·∫£n... t√πy n·ªôi dung user v·ª´a nh·∫≠p.\n` +
                `ƒê·ª´ng ch·ªâ l·∫∑p l·∫°i menu; h√£y th·ª±c hi·ªán h√†nh ƒë·ªông c·ª• th·ªÉ.`;
        }

        callApi(prompt, text);
    }

    // G·ª≠i b·∫±ng Enter khi focus ·ªü √¥ chat
    document.getElementById("chat-input").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            guiChat();
        }
    });
</script>

</body>
</html>
